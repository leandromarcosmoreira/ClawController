FROM node:22-alpine

# Install Python, Rust and dependencies for backend
RUN apk add --no-cache python3 py3-pip gcc musl-dev rust cargo openssl-dev pkgconfig

# Set working directory
WORKDIR /app

# Install pnpm globally
RUN npm install -g pnpm

# Copy package.json files
COPY package.json ./
COPY backend/Cargo.toml ./backend/
COPY frontend/package.json ./frontend/
COPY frontend/pnpm-lock.yaml ./frontend/

# Install frontend dependencies
RUN cd frontend && pnpm install --frozen-lockfile

# Copy source code
COPY backend/ ./backend/
COPY frontend/ ./frontend/

# Build frontend
RUN cd frontend && pnpm build

# Install frontend server
RUN npm install -g serve

# Fix permissions for all directories
RUN chmod -R 755 /app

# Expose ports
EXPOSE 8000 5173

# Development command with backend + frontend static server
# Creates symlink at runtime (after volumes are mounted) so backend finds openclaw.json at ~/.openclaw/openclaw.json
CMD ["sh", "-c", "mkdir -p /root/.openclaw && mkdir -p /app/data && ln -sf /app/config/openclaw.json /root/.openclaw/openclaw.json && cd backend && cargo run --release & serve -s /app/frontend/dist -l 5173 & wait"]
