FROM node:22-alpine

# Install Python and dependencies for backend
RUN apk add --no-cache python3 py3-pip gcc musl-dev

# Set working directory
WORKDIR /app

# Install pnpm globally
RUN npm install -g pnpm

# Copy package.json files
COPY package.json ./
COPY backend/requirements.txt ./backend/

# Copy source code first
COPY backend/ ./backend/

# Install backend dependencies as root
RUN python3 -m venv /app/venv
RUN . /app/venv/bin/activate && pip3 install -r backend/requirements.txt

# Fix permissions for all directories and ensure activate is executable
RUN chmod -R 755 /app && chmod +x /app/venv/bin/activate

# Expose ports for backend only
EXPOSE 8000

# Development command with backend only (running as root)
CMD ["sh", "-c", ". /app/venv/bin/activate && cd backend && python main.py"]
